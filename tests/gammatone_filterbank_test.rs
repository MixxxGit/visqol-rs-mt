use ndarray::{Axis,Array2};
use visqol_rs::{equivalent_rectangular_bandwidth, gammatone_filterbank::GammatoneFilterbank};
use approx::assert_abs_diff_eq;
#[test]
fn gammatone_filterbank()
{
    let fs =  48000;
    let num_bands = 32;
    let min_freq = 50.0f64;

    let ten_samples = vec![0.2, 0.4, 0.6, 0.8, 0.9, 0.1, 0.3, 0.5, 0.7, 0.9];

    let mut erb = equivalent_rectangular_bandwidth::make_filters(fs, num_bands, min_freq, fs as f64 / 2.0);
    erb.filter_coeffs.invert_axis(Axis(0));
    assert_eq!(erb.filter_coeffs.shape()[1], 10);
    assert_eq!(erb.filter_coeffs.shape()[0], num_bands);
    
    let expected_filter_coefficients = vec![0.00002083333333333333263763693932, -0.00002107728648502873536416807321, -0.00002042155431940926880183054259, -0.00002080567332874487350554901233, -0.00002069316747569313066044960348, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.99200307560760292435730889337719, 0.00000000036649852649130750811735,
    0.00002083333333333333263763693932, -0.00002133714927697502369689265544, -0.00002013465262006052238440666213, -0.00002083905885297273211727471509, -0.00002063274304406281396402460249, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.99081126527468799114473085865029, 0.00000000020964213337366030403302,
    0.00002083333333333333263763693932, -0.00002163473688793523641137744873, -0.00001980446991203835364067989411, -0.00002087661548375515665164348089, -0.00002056259131621843340041386194, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.98944278236608529386586496912059, 0.00000000012008004353100333978876,
    0.00002083333333333333263763693932, -0.00002197530432804243712900486851, -0.00001942443837164581292684291391, -0.00002091870105310713912364836697, -0.00002048104164658111093219941545, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.98787174110265285609244756415137, 0.00000000006881959473688393492178,
    0.00002083333333333333263763693932, -0.00002236476040698644979849880887, -0.00001898698743141577491354114737, -0.00002096564102988775080550591656, -0.00002038610680851447390653403968, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.98606856056957348233282800720190, 0.00000000003945489138225129193937,
    0.00002083333333333333263763693932, -0.00002280971958161691622393209278, -0.00001848339198076422875793682621, -0.00002101769601407467834438234922, -0.00002027541554830646663748656977, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.98399946871865218156472110422328, 0.00000000002262683145567935590383,
    0.00002083333333333333263763693932, -0.00002331754514294194087736626642, -0.00001790359967027666961126262934, -0.00002107501550221557024000773595, -0.00002014612931100304024862115981, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.98162595008748110281260323972674, 0.00000000001298044088964449126328,
    0.00002083333333333333263763693932, -0.00002389637638440664983794509135, -0.00001723603600101356042714403904, -0.00002113757306758401195018182150, -0.00001999483931783619831490730889, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.97890413436586432016639491848764, 0.00000000000744928975024265261952,
    0.00002083333333333333263763693932, -0.00002455512898268411638462091484, -0.00001646738689004191856556438833, -0.00002120507651893596061214164461, -0.00001981743935379007433804365856, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.97578412418184490295658406466828, 0.00000000000427682887101555764535,
    0.00002083333333333333263763693932, -0.00002530345300640163852556353830, -0.00001558236026810816310015327113, -0.00002127684455311387287028239423, -0.00001960896872139592875543441519, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.97220926238640203997931621415773, 0.00000000000245661194239881509201,
    0.00002083333333333333263763693932, -0.00002615162619734072291916536501, -0.00001456343149385394555796365001, -0.00002135163878773643081343536210, -0.00001936341890345823766369365293, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.96811534191148962413819845096441, 0.00000000000141185254265390464785,
    0.00002083333333333333263763693932, -0.00002711035069546693544316647018, -0.00001339058273995766341533074362, -0.00002142743673568320490231686737, -0.00001907349669974139395618034643, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.96342976524383927561245855031302, 0.00000000000081192396962263940423,
    0.00002083333333333333263763693932, -0.00002819040820619397120973953497, -0.00001204105519919095215579125241, -0.00002150112716714259274001543043, -0.00001873033623824232893144946244, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.95807066604954527200277425436070, 0.00000000000046725621756440149133,
    0.00002083333333333333263763693932, -0.00002940211043946889071278028016, -0.00001048914673704645605359277866, -0.00002156810436925545357679870340, -0.00001832315280725989488364024993, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.95194601293307246070440896801301, 0.00000000000026912560801160200418,
    0.00002083333333333333263763693932, -0.00003075445687202028844601381374, -0.00000870610908501707214690069903, -0.00002162173219072473589704753982, -0.00001783883376631262130773518393, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.94495272523432716216262861053110, 0.00000000000015515599709693320829,
    0.00002083333333333333263763693932, -0.00003225387863050953291639208476, -0.00000666023159368605426088657401, -0.00002165264291726727081304273992, -0.00001726146730692831805830181335, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.93697584375661491229436705907574, 0.00000000000008954822725885745306,
    0.00002083333333333333263763693932, -0.00003390240370544801289413514023, -0.00000431724826876720443966789498, -0.00002164783107865871289985683357, -0.00001657182089555650443394620164, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.92788781604214276566011676550261, 0.00000000000005174764397617850391,
    0.00002083333333333333263763693932, -0.00003569502359886226076565729493, -0.00000164127853659971618786872494, -0.00002158950054447729543778515537, -0.00001574680159098468151574086449, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.91754797696605450152418370635132, 0.00000000000002994676404011479186,
    0.00002083333333333333263763693932, -0.00003761597584427116443533262169, 0.00000140338077937341514068135540, -0.00002145362913568511688960915862, -0.00001475896592921262901691031866, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.90580233165857215738014929229394, 0.00000000000001735910258234100974,
    0.00002083333333333333263763693932, -0.00003963358671017604622577659712, 0.00000484914370595051444920789430, -0.00002120823648043023329544734534, -0.00001357620652379530017518725199, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.89248377957293301143693042831728, 0.00000000000001008157584827097307,
    0.00002083333333333333263763693932, -0.00004169326075208912584001488821, 0.00000872003014199712497530117550, -0.00002081139193989854356439499206, -0.00001216183867019345730031872066, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.87741295600656743491896349951276, 0.00000000000000586778767366477193,
    0.00002083333333333333263763693932, -0.00004370819690859681138977652082, 0.00001302363318111038120380995586, -0.00002020910346719404694789366805, -0.00001047546026029238323807289690, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.86039990997923765370103410532465, 0.00000000000000342376258998173804,
    0.00002083333333333333263763693932, -0.00004554753194176059435515496743, 0.00001773892670454686563974444624, -0.00001933342245589601609764840440, -0.00000847518278131771261776211679, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.84124688335262576277528978607734, 0.00000000000000200343145312475775,
    0.00002083333333333333263763693932, -0.00004702200677242230876734865874, 0.00002279841858044065466956315524, -0.00001810143966060817760101685214, -0.00000612214853137347988490044037, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.81975250193106730112191371517838, 0.00000000000000117616374715333634,
    0.00002083333333333333263763693932, -0.00004786817561614777321449265557, 0.00002806310730954534270447514599, -0.00001641640841993705752198395853, -0.00000338865988666537298803355105, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.79571772886684255521316799786291, 0.00000000000000069309053743925721,
    0.00002083333333333333263763693932, -0.00004773404853266319984930743381, 0.00003328925619620562046871437012, -0.00001417309684567760197924143201, -0.00000027169549077997401321984267, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.76895395417702916418534186959732, 0.00000000000000041018168535389945,
    0.00002083333333333333263763693932, -0.00004617248299312473418503505185, 0.00003808791140872060554823513856, -0.00001127068486097437764585117714, 0.00000318611327657024562091947484, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.73929358688297985846560322897858, 0.00000000000000024394613230558745,
    0.00002083333333333333263763693932, -0.00004265434152244445479944257027, 0.00004188267000316432122578730324, -0.00000763796482604664235939537914, 0.00000686629330676651217387190113, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.70660345759355469574813923827605, 0.00000000000000014589633480168536,
    0.00002083333333333333263763693932, -0.00003662184563736320776824312295, 0.00004388043918853419349777877922, -0.00000327670746045468968334372570, 0.00001053530101162567287178054021, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.67080120213785654481597475751187, 0.00000000000000008781319595131503,
    0.00002083333333333333263763693932, -0.00002761264979758824725328963945, 0.00004308613245186895834328011379, 0.00000167174465339916226850128234, 0.00001380173800088154543335740299, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.63187454811648857688766156570637, 0.00000000000000005323190922403032,
    0.00002083333333333333263763693932, -0.00001549171057069774197381510639, 0.00003841625338979039812510596352, 0.00000683769922165647617333600686, 0.00001608684359743618421311958655, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.58990303016023493132280464124051, 0.00000000000000003250682435303781,
    0.00002083333333333333263763693932, -0.00000081656659625040866701348868, 0.00002899222666730049877657771074, 0.00001153063985148813154783462021, 0.00001664502021956195686766370734, 0.00000000000000000000000000000000, 1.00000000000000000000000000000000, 0.00000000000000000000000000000000, 0.54508108464140692106525420967955, 0.00000000000000001976646407795415];

    let exptected_filter_coeffs_mat = Array2::from_shape_vec((num_bands, 10), expected_filter_coefficients).unwrap();

    let epsilon = 0.0001;
    
    // Check if coefficients are the same
    for (&res,ex) in erb.filter_coeffs.iter().zip(exptected_filter_coeffs_mat) {
        assert_abs_diff_eq!(res, ex, epsilon=epsilon);
    }

    // Check if filtering works as intended.
    let mut filterbank = GammatoneFilterbank::new(num_bands, min_freq);
    filterbank.reset_filter_conditions();
    filterbank.set_filter_coefficients(&erb.filter_coeffs);

    let filtered_signal = filterbank.apply_filter(&ten_samples);

    // Check dimensions
    assert_eq!(filtered_signal.ncols(), 10);
    assert_eq!(filtered_signal.nrows(), 32);

    // Check individual elements
    let expected_output = vec![1.028e-10,	-2.03944e-10,	-3.06784e-10,	8.09251e-10,	5.58948e-10,	-2.36758e-09,	5.73237e-10,	3.93798e-09,	-3.97086e-09,	-4.60926e-09,	
    1.79716e-10,	-3.5607e-10,	-5.36035e-10,	1.41119e-09,	9.76007e-10,	-4.12624e-09,	1.00277e-09,	6.85309e-09,	-6.92964e-09,	-8.00331e-09,	
    3.13758e-10,	-6.20664e-10,	-9.35441e-10,	2.45644e-09,	1.70237e-09,	-7.17784e-09,	1.75007e-09,	1.19022e-08,	-1.20706e-08,	-1.38665e-08,	
    5.47461e-10,	-1.08089e-09,	-1.63183e-09,	4.27111e-09,	2.96882e-09,	-1.24714e-08,	3.04809e-09,	2.06438e-08,	-2.09993e-08,	-2.39906e-08,	
    9.54914e-10,	-1.88096e-09,	-2.84653e-09,	7.41892e-09,	5.17899e-09,	-2.16455e-08,	5.29587e-09,	3.57632e-08,	-3.64885e-08,	-4.14547e-08,	
    1.6651e-09,	-3.27049e-09,	-4.96613e-09,	1.28723e-08,	9.04034e-09,	-3.75235e-08,	9.17092e-09,	6.18768e-08,	-6.33118e-08,	-7.15445e-08,	
    2.90252e-09,	-5.6809e-09,	-8.66684e-09,	2.2305e-08,	1.5797e-08,	-6.49583e-08,	1.58095e-08,	1.06906e-07,	-1.09657e-07,	-1.23326e-07,	
    5.05767e-09,	-9.85593e-09,	-1.51337e-08,	3.85887e-08,	2.76463e-08,	-1.12266e-07,	2.70835e-08,	1.8441e-07,	-1.89497e-07,	-2.12343e-07,	
    8.80934e-09,	-1.70739e-08,	-2.64485e-08,	6.66314e-08,	4.84902e-08,	-1.93644e-07,	4.59975e-08,	3.17529e-07,	-3.26529e-07,	-3.65244e-07,	
    1.53366e-08,	-2.95235e-08,	-4.62816e-08,	1.1478e-07,	8.53065e-08,	-3.33212e-07,	7.71838e-08,	5.45643e-07,	-5.60594e-07,	-6.27776e-07,	
    2.66855e-08,	-5.09332e-08,	-8.11323e-08,	1.97141e-07,	1.50681e-07,	-5.71706e-07,	1.27324e-07,	9.35521e-07,	-9.57955e-07,	-1.07866e-06,	
    4.64034e-08,	-8.76138e-08,	-1.42577e-07,	3.37353e-07,	2.67546e-07,	-9.77397e-07,	2.04908e-07,	1.59994e-06,	-1.62721e-06,	-1.85395e-06,	
    8.06325e-08,	-1.50155e-07,	-2.51379e-07,	5.74592e-07,	4.78156e-07,	-1.66357e-06,	3.17694e-07,	2.72859e-06,	-2.74287e-06,	-3.19032e-06,	
    1.39994e-07,	-2.56128e-07,	-4.45102e-07,	9.72793e-07,	8.61311e-07,	-2.81572e-06,	4.63798e-07,	4.63893e-06,	-4.57793e-06,	-5.50322e-06,	
    2.42827e-07,	-4.34226e-07,	-7.92351e-07,	1.63403e-06,	1.56565e-06,	-4.73203e-06,	6.06917e-07,	7.85928e-06,	-7.54335e-06,	-9.53011e-06,	
    4.20734e-07,	-7.30292e-07,	-1.41971e-06,	2.71596e-06,	2.8743e-06,	-7.87945e-06,	6.14908e-07,	1.32629e-05,	-1.2223e-05,	-1.65971e-05,	
    7.28072e-07,	-1.21522e-06,	-2.56311e-06,	4.44946e-06,	5.32998e-06,	-1.29606e-05,	1.18618e-07,	2.22807e-05,	-1.93709e-05,	-2.91205e-05,	
    1.2581e-06,	-1.99319e-06,	-4.66595e-06,	7.14122e-06,	9.97391e-06,	-2.09657e-05,	-1.79227e-06,	3.72284e-05,	-2.9791e-05,	-5.15535e-05,	
    2.17039e-06,	-3.20438e-06,	-8.56604e-06,	1.11167e-05,	1.87895e-05,	-3.31289e-05,	-7.18309e-06,	6.17893e-05,	-4.39333e-05,	-9.21618e-05,	
    3.73712e-06,	-5.00514e-06,	-1.58462e-05,	1.64869e-05,	3.5486e-05,	-5.05803e-05,	-2.04197e-05,	0.000101667,	-6.08913e-05,	-0.000166288,	
    6.42082e-06,	-7.48302e-06,	-2.94718e-05,	2.24583e-05,	6.67582e-05,	-7.32206e-05,	-5.00833e-05,	0.000165342,	-7.62494e-05,	-0.000302131,	
    1.10043e-05,	-1.04069e-05,	-5.48838e-05,	2.55521e-05,	0.000123951,	-9.68804e-05,	-0.00011163,	0.000264657,	-7.78835e-05,	-0.000550337,	
    1.88057e-05,	-1.25928e-05,	-0.000101674,	1.54339e-05,	0.000224172,	-0.000107262,	-0.000229733,	0.000414666,	-3.82581e-05,	-0.000998162,	
    3.2033e-05,	-1.04256e-05,	-0.000185555,	-3.394e-05,	0.000387329,	-6.93539e-05,	-0.000436702,	0.000632135,	9.94256e-05,	-0.00178568,	
    5.43595e-05,	5.36601e-06,	-0.000328798,	-0.000180686,	0.000619831,	8.50231e-05,	-0.000759532,	0.000933456,	0.000446853,	-0.00311039,	
    9.1852e-05,	5.63328e-05,	-0.000553017,	-0.000538,	0.000867237,	0.000454269,	-0.00118792,	0.00133665,	0.00121972,	-0.00517749,	
    0.000154444,	0.000189021,	-0.000848423,	-0.0012836,	0.000919457,	0.00109952,	-0.00163697,	0.00187322,	0.00282554,	-0.00799217,	
    0.000258238,	0.000497346,	-0.0010872,	-0.00257716,	0.000313006,	0.0018406,	-0.0019889,	0.00258244,	0.00596722,	-0.0108144,	
    0.000429047,	0.00115707,	-0.000836723,	-0.00419807,	-0.00150279,	0.00197456,	-0.00238367,	0.00333605,	0.0115556,	-0.0111822,	
    0.000707771,	0.0024669,	0.000925124,	-0.00468698,	-0.00410859,	0.000528262,	-0.00372423,	0.00322284,	0.019876,	-0.00416104,	
    0.00115902,	0.00486876,	0.00595154,	-0.000409927,	-0.003975,	-0.00179116,	-0.00740963,	-0.000163866,	0.0288261,	0.0159466,	
    0.00190606,	0.00896774,	0.0160988,	0.0129883,	0.00532951,	-0.000345059,	-0.0132442,	-0.00928673,	0.0349696,	0.0503187];

    let expected_output_mat = Array2::from_shape_vec((32, 10), expected_output).unwrap();

    for (&res,ex) in filtered_signal.iter().zip(expected_output_mat) 
    {
        assert_abs_diff_eq!(res, ex, epsilon=epsilon);
    }


}